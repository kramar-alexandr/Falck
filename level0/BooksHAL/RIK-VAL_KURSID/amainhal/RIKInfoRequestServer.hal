// <halrule>server-only</halrule>

//xml tools
external procedure EstEInvBuildString2(string,string,var string);
external procedure EstEInvEndTag(string,area);
external procedure EstEInvStartTag(string,area);
external procedure EstEInvStartTag2(string,var string,area);
external procedure EstEInvTagValue(string,string,integer,area); 
//txt tools
external procedure ExtractObjWithSeparator(string,string,Boolean,var Integer,var string);
//external procedure LogAreaToFile(string,area);

global
procedure DoSendAddrLookupRequestToPartner(string regno,string namestr,string service,string RequestType,var area reply,var Boolean noResult,var Boolean res) 
begin
  record ServiceCacheVc SCr;
  record TXTSerBlock TXTSerbl;
  Boolean found;
  Integer errcode,alen,i;
  string 60 tstr,targetTag,rTag;
  string 150 user,passwd;
  xml xmlReply;
  Area a;

  BlockLoad(TXTSerbl);
  SCr.Code = "SENDESTADRLOOKUP";
  SCr.Partner = "ESTADRLOOKUP";
  found = ReadFirstMain(SCr,2,true);
  if (found==false) then begin
    SCr.Code = "SENDESTADRLOOKUP";
    SCr.Partner = "";
    found = ReadFirstMain(SCr,2,true);
  end; 
  if (found) then begin   
  if(Len(RequestType)>0) then begin
    user = TXTSerbl.dbUser;
    passwd = TXTSerbl.dbPasswd;
    SCr.Code = service;
//    if (ReadFirstMain(SCr,1,true)==true) then begin
    EstEInvBuildString2("xmlns:xsi","http://www.w3.org/2001/XMLSchema-instance",tstr);
    EstEInvBuildString2("xmlns:xsd","http://www.w3.org/2001/XMLSchema",tstr);
    EstEInvBuildString2("xmlns:soapenv","http://schemas.xmlsoap.org/soap/envelope/",tstr);
    EstEInvBuildString2("xmlns:arir","http://producers.arireg.xtee.riik.ee/producer/arireg",tstr);
    EstEInvStartTag2("soapenv:Envelope",tstr,a);
    EstEInvTagValue("soapenv:Header","",0,a);
    EstEInvStartTag("soapenv:Body",a);
    tstr = "";
    EstEInvBuildString2("soapenv:encodingStyle","http://schemas.xmlsoap.org/soap/encoding/",tstr);
    EstEInvStartTag2("arir:ettevotja_rekvisiidid",tstr,a);
    tstr = "";
    EstEInvBuildString2("xsi:type","arir:" & RequestType,tstr);
    EstEInvStartTag2("keha",tstr,a);
    tstr = "";
    EstEInvBuildString2("xsi:type","xsd:string",tstr);
    EstEInvStartTag2("ariregister_kasutajanimi",tstr,a);
    AddTextToArea(user,a);
    EstEInvEndTag("ariregister_kasutajanimi",a);
    tstr = "";
    EstEInvBuildString2("xsi:type","xsd:string",tstr);
    EstEInvStartTag2("ariregister_parool",tstr,a);
    AddTextToArea(passwd,a);
    EstEInvEndTag("ariregister_parool",a);
    tstr = "";
    EstEInvBuildString2("xsi:type","xsd:string",tstr);
    EstEInvStartTag2("ariregister_valjundi_formaat",tstr,a);
    AddTextToArea("xml",a);
    EstEInvEndTag("ariregister_valjundi_formaat",a);
    if (blank(regno) and nonblank(namestr)) then begin
      tstr = "";
      EstEInvBuildString2("xsi:type","xsd:string",tstr);
      EstEInvStartTag2("nimi",tstr,a);
      AddTextToArea(namestr,a);
      EstEInvEndTag("nimi",a);
    end;
    if (nonblank(regno)) then begin
      tstr = "";
      EstEInvBuildString2("xsi:type","xsd:integer",tstr);
      EstEInvStartTag2("ariregistri_kood",tstr,a);
      AddTextToArea(regno,a);
      EstEInvEndTag("ariregistri_kood",a);
    end;
    tstr = "";
    EstEInvBuildString2("xsi:type","xsd:integer",tstr);
    EstEInvStartTag2("ettevotjate_arv_valjundis",tstr,a);
    AddTextToArea(TXTSerbl.dbNumber,a);
    EstEInvEndTag("ettevotjate_arv_valjundis",a);

    EstEInvEndTag("keha",a);

    EstEInvEndTag("arir:ettevotja_rekvisiidid",a);

    EstEInvEndTag("soapenv:Body",a);
    EstEInvEndTag("soapenv:Envelope",a);
//  Debug
//      LogAreaToFile("debug/request/gc_initialize."&CountFilesInDir("debug/request/")&".request.xml",a); //TODO: remove
    res = SendWebRequest(SCr.ServiceHost,SCr.ServicePort,-1,true,"POST",SCr.FuncName,"text/xml; charset=utf-8","",false,a,reply,10);
    if (res) then begin
      xmlReply = ParseXmlArea(reply);
      if !(XmlNodeExists(xmlReply,"SOAP-ENV:Envelope/SOAP-ENV:Body/ns1:ettevotja_rekvisiididResponse/keha/ettevotjad/Item/nimi")) then begin
        noResult = true;
      end;
      if (XmlNodeExists(xmlReply,"SOAP-ENV:Envelope/SOAP-ENV:Body/SOAP-ENV:Fault/faultcode")) then begin
        tstr = XmlGet(xmlReply,"SOAP-ENV:Envelope/SOAP-ENV:Body/SOAP-ENV:Fault/faultstring");
//          LogText(0,"RIK :" & tstr);
        res = false;
      end else begin
        res = true;
      end;
    end else begin
      LogText(0,"DoSendAddrLookupRequestToPartner: Sending HALTED. Sender UsernameAtPartner==blank");
    end;
  end;
 // Debug
 //     LogAreaToFile("debug/reply/gc_initialize."&CountFilesInDir("debug/reply/")&".reply.xml",reply); //TODO: remove
  end;
  return;
end;
